<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Conversation Scraper - Growth Swift</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f3f4f6; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
  </head>
  <body class="bg-gradient-to-br from-gray-50 to-gray-200 min-h-screen flex flex-col items-center p-8">

    <header class="bg-white shadow-md rounded-2xl px-6 py-4 flex justify-between items-center w-full max-w-4xl mb-10 border border-gray-100">
      <div class="w-40 flex items-center justify-center">
        <img src="/static/logo.png" alt="Logo" class="max-h-12 object-contain" />
      </div>
      <div class="text-right">
        <h1 class="text-xl font-bold text-gray-800 tracking-tight">Conversation Scraper</h1>
        <span class="text-xs text-gray-500 uppercase tracking-wider">Social Sentiment Analysis</span>
      </div>
    </header>

    <main class="bg-white/90 backdrop-blur-xl p-8 rounded-2xl shadow-xl border border-gray-100 w-full max-w-2xl space-y-6">
      
      <a href="/" class="inline-flex items-center text-gray-500 hover:text-green-600 transition mb-2">
        ‚Üê Back to Hub
      </a>

      <form id="scrapeForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Discussion URL (Reddit/Forum)</label>
          <input 
            type="url" 
            id="url" 
            placeholder="https://www.reddit.com/r/technology/comments/..." 
            class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none transition" 
            required 
          />
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Max Comments</label>
                <select id="limit" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none bg-white">
                    <option value="10">10 (Quick)</option>
                    <option value="50" selected>50 (Standard)</option>
                    <option value="100">100 (Deep)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                <select id="sort" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none bg-white">
                    <option value="new">Newest First</option>
                    <option value="top">Top / Best</option>
                </select>
            </div>
        </div>

        <button 
          type="submit" 
          class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5"
        >
          Extract Comments
        </button>
      </form>

      <div id="loading" class="hidden flex flex-col items-center justify-center py-8">
        <div class="animate-spin rounded-full h-10 w-10 border-b-4 border-green-600 mb-3"></div>
        <p class="text-gray-500 text-sm animate-pulse">Scrolling & extracting data...</p>
      </div>

      <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm"></div>

      <div id="results" class="hidden space-y-4">
        <div class="flex justify-between items-center border-b border-gray-200 pb-2">
            <h3 class="font-bold text-gray-800">Results (<span id="count">0</span>)</h3>
            <button id="downloadBtn" class="text-sm text-green-700 bg-green-100 hover:bg-green-200 px-3 py-1 rounded-lg transition font-medium">
                Download CSV
            </button>
        </div>

        <div id="conversationBox" class="custom-scrollbar bg-gray-50 rounded-xl p-4 h-80 overflow-y-auto space-y-3 border border-gray-200">
            </div>
      </div>

    </main>

    <script>
      let scrapedData = [];
      const form = document.getElementById("scrapeForm");
      const loading = document.getElementById("loading");
      const results = document.getElementById("results");
      const errorDiv = document.getElementById("error");
      const conversationBox = document.getElementById("conversationBox");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        // Reset UI
        loading.classList.remove("hidden");
        results.classList.add("hidden");
        errorDiv.classList.add("hidden");
        conversationBox.innerHTML = ""; 
        
        const url = document.getElementById("url").value;
        const limit = document.getElementById("limit").value;
        const sort = document.getElementById("sort").value;

        try {
            const response = await fetch("/api/scrape_conversation", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url, limit, sort })
            });

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || "Failed to scrape.");
            }

            scrapedData = data.results;
            document.getElementById("count").innerText = scrapedData.length;

            if (scrapedData.length === 0) {
                conversationBox.innerHTML = `<p class="text-center text-gray-400 mt-10">No comments found. (Check if the site is blocking bots)</p>`;
            } else {
                scrapedData.forEach(comment => {
                    const div = document.createElement("div");
                    div.className = "bg-white p-3 rounded-lg shadow-sm border border-gray-100";
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-xs text-gray-600">${comment.author || "Unknown"}</span>
                            <span class="text-[10px] text-gray-400">${comment.date || ""}</span>
                        </div>
                        <p class="text-sm text-gray-800 leading-relaxed">${comment.text}</p>
                    `;
                    conversationBox.appendChild(div);
                });
            }

            results.classList.remove("hidden");

        } catch (err) {
            errorDiv.innerText = "Error: " + err.message;
            errorDiv.classList.remove("hidden");
        } finally {
            loading.classList.add("hidden");
        }
      });

      document.getElementById("downloadBtn").addEventListener("click", () => {
          if (!scrapedData.length) return;
          
          fetch("/api/download", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ results: scrapedData })
          })
          .then(res => res.blob())
          .then(blob => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "conversation_data.csv";
              document.body.appendChild(a);
              a.click();
              a.remove();
          });
      });
    </script>
  </body>
</html>